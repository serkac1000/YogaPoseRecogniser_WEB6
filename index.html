<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yoga Pose Recognition</title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <div class="container">
        <div class="main-content">
            <div class="camera-section">
                <video id="webcam" autoplay></video>
                <canvas id="canvas"></canvas>
            </div>
            <div class="reference-section">
                <img src="https://teachablemachine.withgoogle.com/models/gIF64n3nR/pose1.jpg" alt="Pose 1" class="reference-pose">
                <div class="stats">
                    <div class="confidence">Confidence: <span id="confidence">0</span>%</div>
                    <div class="timer">Hold Time: <span id="timer">3</span>s</div>
                </div>
                <div class="controls">
                    <button id="startBtn">Start Recognition</button>
                    <button id="stopBtn">Stop</button>
                    <button id="exportBtn" onclick="exportToGithub()">Export to GitHub</button>
                </div>
                <script>
                    async function exportToGithub() {
                        const token = prompt("Please enter your GitHub token:");
                        if (!token) {
                            alert('Token is required for GitHub export');
                            return;
                        }
                        try {
                            const response = await fetch('/export-github', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ token })
                            });
                            const result = await response.json();
                            if (result.success) {
                                alert('Successfully exported to GitHub! Check your repositories.');
                            } else {
                                alert('Export failed: ' + result.error);
                            }
                        } catch (error) {
                            console.error('Export error:', error);
                            alert('Export failed. Check console for details.');
                        }
                    }
                </script>
            </div>
        </div>
    </div>
    <script>
        const ws = new WebSocket(`ws://${window.location.hostname}:5000`);
        let detector;
        let isRunning = false;
        let lastConfidence = 0;
        const MODEL_URL = 'https://teachablemachine.withgoogle.com/models/gIF64n3nR/';

        async function loadModel() {
            try {
                detector = await tmPose.load(MODEL_URL + 'model.json', MODEL_URL + 'metadata.json');
                console.log('Model loaded successfully');
                return true;
            } catch (error) {
                console.error('Failed to load model:', error);
                return false;
            }
        }

        async function setupCamera() {
            const video = document.getElementById('webcam');
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { 
                    width: 640,
                    height: 480,
                    facingMode: 'user'
                } 
            });
            video.srcObject = stream;
            await new Promise((resolve) => {
                video.onloadedmetadata = () => resolve(video);
            });

            if (!detector) {
                const modelLoaded = await loadModel();
                if (!modelLoaded) {
                    document.getElementById('startBtn').disabled = true;
                    return null;
                }
            }
            return video;
        }

        async function detectPose() {
            if (!isRunning || !detector) return;

            const video = document.getElementById('webcam');
            try {
                const confidence = await detector.estimatePose(video);
                if (!confidence) return;

                const confidencePercentage = Math.round(confidence * 100);
                lastConfidence = lastConfidence * 0.7 + confidencePercentage * 0.3;
                const smoothedConfidence = Math.round(lastConfidence);

                document.getElementById('confidence').textContent = smoothedConfidence;

                if (smoothedConfidence > 46) {
                    ws.send(JSON.stringify({
                        type: 'poseDetection',
                        confidence: smoothedConfidence / 100
                    }));
                }
            } catch (error) {
                console.error('Error during pose detection:', error);
            }
        }

        ws.onmessage = (event) => {
            const message = JSON.parse(event.data);
            if (message.type === 'timer') {
                document.getElementById('timer').textContent = message.timeLeft;
            }
        };

        document.getElementById('startBtn').addEventListener('click', () => {
            isRunning = true;
            detectPose();
        });

        document.getElementById('stopBtn').addEventListener('click', () => {
            isRunning = false;
        });

        setupCamera().then(() => {
            setInterval(() => {
                if (isRunning) {
                    detectPose();
                }
            }, 100);
        });
    </script>
</body>
</html>